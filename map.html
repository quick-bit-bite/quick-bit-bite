<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Global Pulse – Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Basic CSS styling -->
  <style>
    body { margin: 0; font-family: sans-serif; background: #f0f2f5; color: #333; display: flex; flex-direction: column; }
    header, footer { background: #2c3e50; color: #fff; padding: 1rem; text-align: center; }
    nav { background: #34495e; padding: 0.5rem; text-align: center; }
    nav a { color: #fff; text-decoration: none; margin: 0 1rem; font-weight: bold; }
    #container { flex: 1; display: flex; flex-direction: row; }
    #map { flex: 2; height: 80vh; }
    #sidebar { flex: 1; padding: 1rem; background: #fff; overflow-y: auto; border-left: 1px solid #ddd; }
    form { margin-bottom: 1rem; }
    form label { display: block; margin-top: 0.5rem; }
    form input, form select, form button { width: 100%; padding: 0.5rem; margin-top: 0.2rem; margin-bottom: 0.5rem; box-sizing: border-box; }
    #gmapsUrl { margin-bottom: 0.2rem; }
    #useMyLocationBtn { background: #2c3e50; color: #fff; padding: 0.4rem; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 1rem; }
    #useMyLocationBtn:hover { background: #34495e; }
    .tab-buttons { display: flex; justify-content: space-around; margin-bottom: 1rem; }
    .tab-buttons button { flex: 1; padding: 0.5rem; border: none; background: #ddd; cursor: pointer; }
    .tab-buttons button.active { background: #2c3e50; color: #fff; }
    .video-item { margin-bottom: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; }
    .video-item iframe, .video-item video { width: 100%; max-width: 300px; }
    .location-btn { background: #2c3e50; color: #fff; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
    .location-btn:hover { background: #34495e; }
  </style>
</head>
<body>
  <header>
    <h1>Global Pulse – Map</h1>
    <p>Discover mood videos near you</p>
  </header>
  
  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="map.html">Map</a>
  </nav>
  
  <div id="container">
    <!-- Map container -->
    <div id="map"></div>
    
    <!-- Sidebar for submission form and video list -->
    <div id="sidebar">
      <h2>Submit Your Mood Video</h2>
      <form id="videoForm">
        <!-- Video Type Selection -->
        <label>Video Type:</label>
        <input type="radio" name="vtype" value="mp4" id="typeMP4" checked>
        <label for="typeMP4" style="display:inline;">Upload MP4</label>
        <input type="radio" name="vtype" value="youtube" id="typeYT">
        <label for="typeYT" style="display:inline;">YouTube Link</label>
        
        <!-- Conditional Inputs -->
        <div id="mp4Input">
          <label for="fileInput">Select MP4 file (max 500MB):</label>
          <input type="file" id="fileInput" accept="video/mp4">
        </div>
        <div id="ytInput" style="display:none;">
          <label for="videoURL">YouTube Video URL:</label>
          <input type="url" id="videoURL" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        
        <!-- Google Maps URL Input & Use My Location -->
        <label for="gmapsUrl">Google Maps URL (or auto-fill with your location):</label>
        <input type="url" id="gmapsUrl" placeholder="https://www.google.com/maps/place/..." required>
        <button type="button" id="useMyLocationBtn">Use My Current Location</button>
        
        <!-- Tag / Keywords -->
        <label for="tag">Tag / Keywords (e.g., Times Square):</label>
        <input type="text" id="tag" placeholder="Enter keywords" required>
        
        <!-- Retention Period -->
        <label for="retention">Display Duration:</label>
        <select id="retention" required>
          <option value="1">1 Day</option>
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
          <option value="182">6 Months</option>
          <option value="365">1 Year</option>
        </select>
        
        <button type="submit">Submit Video</button>
      </form>
      
      <button class="location-btn" onclick="centerOnUser()">Center on My Location</button>
      
      <hr>
      
      <!-- Tabs for Active and History Videos -->
      <div class="tab-buttons">
        <button id="activeTab" class="active" onclick="setTab('active')">Active</button>
        <button id="historyTab" onclick="setTab('history')">History</button>
      </div>
      
      <input type="text" id="searchBox" placeholder="Search by tag...">
      <h3>Videos near center (within 10 km):</h3>
      <div id="videoList"></div>
      <button id="refreshBtn">Refresh List</button>
    </div>
  </div>
  
  <footer>
    <p>&copy; 2025 Global Pulse. All rights reserved.</p>
  </footer>
  
  <!-- Google Maps API script (replace YOUR_API_KEY with your actual key) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
  
  <script>
    // Global data array for video submissions
    let videos = [];
    let currentTab = 'active'; // 'active' or 'history'
    let map;
    let infoWindow;
    
    // Load submissions from localStorage if available
    if (localStorage.getItem('videoSubmissions')) {
      videos = JSON.parse(localStorage.getItem('videoSubmissions'));
    }
    function saveVideos() {
      localStorage.setItem('videoSubmissions', JSON.stringify(videos));
    }
    
    // Initialize Google Map
    function initMap() {
      // Default center if geolocation fails
      let defaultCenter = { lat: 20, lng: 0 };
      map = new google.maps.Map(document.getElementById('map'), {
        center: defaultCenter,
        zoom: 2,
      });
      infoWindow = new google.maps.InfoWindow();
      centerOnUser();
      refreshLists();
      
      // Re-add markers from saved submissions (active only)
      videos.forEach(video => {
        if (Date.now() < video.expiration) {
          addVideoMarker(video);
        }
      });
    }
    
    // Use navigator.geolocation to center map on user's location
    function centerOnUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          let userPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(userPos);
          map.setZoom(13);
          refreshLists();
        }, function(error) {
          alert("Error retrieving location: " + error.message);
        });
      } else {
        alert("Geolocation not supported by your browser.");
      }
    }
    
    // Update form display based on selected video type
    Array.from(document.getElementsByName('vtype')).forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'mp4') {
          document.getElementById('mp4Input').style.display = 'block';
          document.getElementById('ytInput').style.display = 'none';
          document.getElementById('videoURL').required = false;
          document.getElementById('fileInput').required = true;
        } else {
          document.getElementById('mp4Input').style.display = 'none';
          document.getElementById('ytInput').style.display = 'block';
          document.getElementById('videoURL').required = true;
          document.getElementById('fileInput').required = false;
        }
      });
    });
    
    // Fill the Google Maps URL input automatically using current location
    document.getElementById('useMyLocationBtn').addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          let lat = position.coords.latitude;
          let lng = position.coords.longitude;
          let gmapsLink = "https://www.google.com/maps/place/" + lat + "," + lng;
          document.getElementById('gmapsUrl').value = gmapsLink;
        }, function(error) {
          alert("Error retrieving location: " + error.message);
        });
      } else {
        alert("Geolocation not supported by your browser.");
      }
    });
    
    // Parse coordinates from a Google Maps URL (pattern: /@lat,lng,)
    function parseGMapsURL(url) {
      let regex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
      let match = url.match(regex);
      if (match) {
        return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
      }
      return null;
    }
    
    // Haversine formula to calculate distance (in km)
    function distance(lat1, lng1, lat2, lng2) {
      let R = 6371;
      let dLat = (lat2 - lat1) * Math.PI / 180;
      let dLng = (lng2 - lng1) * Math.PI / 180;
      let a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) ** 2;
      let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    
    // Add a video marker on the map using Google Maps Marker
    function addVideoMarker(video) {
      let marker = new google.maps.Marker({
        position: { lat: video.lat, lng: video.lng },
        map: map
      });
      let embedHTML = "";
      if (video.type === "youtube") {
        let videoId = "";
        if (video.videoURL.includes("youtu.be")) {
          videoId = video.videoURL.split("youtu.be/")[1].split("?")[0];
        } else {
          let urlObj = new URL(video.videoURL);
          videoId = urlObj.searchParams.get("v");
        }
        embedHTML = '<iframe width="300" height="169" src="https://www.youtube.com/embed/' + videoId + '" frameborder="0" allowfullscreen></iframe>';
      } else {
        embedHTML = '<video width="300" controls><source src="' + video.videoURL + '" type="video/mp4">Your browser does not support the video tag.</video>';
      }
      let contentString = '<div><strong>Tag:</strong> ' + video.tag +
                          '<br><em>Expires on:</em> ' + new Date(video.expiration).toLocaleDateString() +
                          '<br>' + embedHTML + '</div>';
      marker.addListener("click", function() {
        infoWindow.setContent(contentString);
        infoWindow.open(map, marker);
      });
      video.marker = marker;
    }
    
    // Handle video submission form
    document.getElementById('videoForm').addEventListener('submit', function(event) {
      event.preventDefault();
      let vtype = document.querySelector('input[name="vtype"]:checked').value;
      let gmapsUrl = document.getElementById('gmapsUrl').value;
      let tag = document.getElementById('tag').value.toLowerCase();
      let retentionDays = parseInt(document.getElementById('retention').value);
      let coords = parseGMapsURL(gmapsUrl);
      if (!coords) {
        alert("Invalid Google Maps URL format.");
        return;
      }
      let expiration = Date.now() + retentionDays * 24 * 60 * 60 * 1000;
      if (vtype === "mp4") {
        let fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) {
          alert("Please select an MP4 file.");
          return;
        }
        let file = fileInput.files[0];
        if (file.size > 500 * 1024 * 1024) {
          alert("File exceeds 500MB limit.");
          return;
        }
        let blobURL = URL.createObjectURL(file);
        let submission = { type: "mp4", videoURL: blobURL, lat: coords.lat, lng: coords.lng, tag: tag, expiration: expiration, timestamp: Date.now() };
        videos.push(submission);
        addVideoMarker(submission);
        saveVideos();
        this.reset();
        refreshLists();
      } else {
        let videoURL = document.getElementById('videoURL').value;
        if (!videoURL) {
          alert("Please enter a YouTube link.");
          return;
        }
        let submission = { type: "youtube", videoURL: videoURL, lat: coords.lat, lng: coords.lng, tag: tag, expiration: expiration, timestamp: Date.now() };
        videos.push(submission);
        addVideoMarker(submission);
        saveVideos();
        this.reset();
        refreshLists();
      }
    });
    
    // Refresh the video list in the sidebar based on map center and current tab
    function refreshLists() {
      let now = Date.now();
      let activeVideos = [];
      let historyVideos = [];
      videos.forEach(function(video) {
        if (now < video.expiration) {
          activeVideos.push(video);
        } else {
          historyVideos.push(video);
        }
      });
      if (currentTab === "active") {
        displayActiveVideos(activeVideos);
      } else {
        displayHistoryVideos(historyVideos);
      }
    }
    
    function displayActiveVideos(activeVideos) {
      let center = map.getCenter();
      let listDiv = document.getElementById('videoList');
      listDiv.innerHTML = "";
      let searchTerm = document.getElementById('searchBox').value.toLowerCase();
      activeVideos.forEach(function(video) {
        let d = distance(center.lat, center.lng, video.lat, video.lng);
        if (d <= 10 && video.tag.includes(searchTerm)) {
          let item = document.createElement("div");
          item.className = "video-item";
          item.innerHTML = '<strong>Tag:</strong> ' + video.tag +
                           '<br><em>Expires:</em> ' + new Date(video.expiration).toLocaleDateString() +
                           '<br><a href="#" onclick="zoomToVideo(' + videos.indexOf(video) + '); return false;">View on Map</a>';
          listDiv.appendChild(item);
        }
      });
    }
    
    function displayHistoryVideos(historyVideos) {
      let listDiv = document.getElementById("videoList");
      listDiv.innerHTML = "";
      let groups = {};
      historyVideos.forEach(function(video) {
        let year = new Date(video.expiration).getFullYear();
        if (!groups[year]) groups[year] = [];
        groups[year].push(video);
      });
      for (let year in groups) {
        let header = document.createElement("h4");
        header.textContent = "History - " + year;
        listDiv.appendChild(header);
        groups[year].forEach(function(video) {
          let item = document.createElement("div");
          item.className = "video-item";
          item.innerHTML = '<strong>Tag:</strong> ' + video.tag +
                           '<br><em>Expired:</em> ' + new Date(video.expiration).toLocaleDateString();
          listDiv.appendChild(item);
        });
      }
    }
    
    function zoomToVideo(index) {
      let video = videos[index];
      let pos = { lat: video.lat, lng: video.lng };
      map.setCenter(pos);
      map.setZoom(15);
      if(video.marker) {
        google.maps.event.trigger(video.marker, 'click');
      }
    }
    
    // Tab control functions
    function setTab(tab) {
      currentTab = tab;
      document.getElementById("activeTab").classList.toggle("active", tab === "active");
      document.getElementById("historyTab").classList.toggle("active", tab === "history");
      refreshLists();
    }
    
    // Event listeners for refresh and search
    document.getElementById("refreshBtn").addEventListener("click", refreshLists);
    document.getElementById("searchBox").addEventListener("input", refreshLists);
    
    // On window load, the Google Maps API calls initMap (via callback)
  </script>
</body>
</html>
